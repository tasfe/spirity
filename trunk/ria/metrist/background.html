<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    </head>
    <body>
        <script type="text/javascript" src="assets/yui-special/yahoo.js"></script>
        <script type="text/javascript" src="assets/yui-special/dom.js"></script>
        <script type="text/javascript" src="assets/yui-special/event.js"></script>
        <script type="text/javascript" src="assets/yui-special/animation.js"></script>
        <script type="text/javascript" src="assets/yui-special/connection_core.js"></script>
        <script type="text/javascript" src="assets/scripts/common.js"></script>
        <script type="text/javascript" src="assets/scripts/twitter.js"></script>
        <script type="text/javascript">
            ~function() {
                var Y = YAHOO, Lang = Y.lang, timer;

                if (localStorage['conf_use_console'] == 'yes') {
                    window.console = logger;
                }

                var twitter_username = localStorage['conf_twitter_username'],
                    twitter_password = localStorage['conf_twitter_password'];
                if (!twitter_username || !twitter_password) {
                    chrome.tabs.create({url: 'options.html'});
                    return;
                }

                //'http://lab.gracecode.com/twip-nobody-knows',
                Twitter.setConfig({
                    api: localStorage['conf_twitter_request_api'] || 'http://twitter.com',
                    username: twitter_username,
                    password: twitter_password,
                    timeout: parseInt(localStorage['conf_request_timeout'], 10) || 5000
                    count: parseInt(localStorage['conf_request_count'], 10) || 10,
                });

                var requestDataAndShow = function() {
                    // 获取用户本身数据，并添加到“好友”列表
                    Twitter.getUserTimeline(twitter_username, {
                        onSuccess: function(o) {
                            Tweets.addToList('friends', JSON.parse(o.responseText));
                            console.log('getUserTimeline successful');
                            getFriendsTimeline();
                        },
                        onError: function() {
                            console.error('getFriendsTimeline error!');
                        }
                    });
                }

                // 获取好友数据
                var getFriendsTimeline = function() {
                    Twitter.getFriendsTimeline({
                        onSuccess: function(o) {
                            Tweets.addToList('friends', JSON.parse(o.responseText));
                            console.log('getFriendsTimeline successful');
                            getReplies();
                        }, 
                        onError: function() {
                            console.error('getFriendsTimeline faild');
                        }
                    });
                }

                // 获取回复数据
                var getReplies = function () {
                    Twitter.getReplies({
                        onSuccess: function(o) {
                            Tweets.addToList('replies', JSON.parse(o.responseText));
                            console.log('getReplies successful');
                            getDirectMessages();
                        }, 
                        onError: function() {
                            console.error('getReplies faild');
                        }
                    });
                }

                // 获取私信数据
                var getDirectMessages = function() {
                    Twitter.getDirectMessages({
                        onSuccess: function(o) {
                            Tweets.addToList('direct', JSON.parse(o.responseText));
                            console.log('getDirectMessages successful');
                            if (Tweets.getDiffNumber()) {
                                chrome.browserAction.setBadgeText({text: Tweets.getDiffNumber() + ''});
                            }
                        }, 
                        onError: function() {
                            console.error('getDirectMessages faild');
                        }
                    });
                }


                /**
                 * 向服务器请求 Tweets 信息
                 */
                var requestTweets = function () {
                    localStorage['status_last_request_tweets'] = new Date;
                    if (timer) {
                        timer.cancel();
                    }
                    requestDataAndShow();

                    var minutes = parseInt(localStorage['conf_per_request_time'], 10) || 10;
                    timer = Lang.later(minutes * 60 * 1000, Twitter, requestTweets);
                }

                // Already Login
                if (localStorage['status_last_login_username'] == twitter_username && localStorage['status_is_logined'] == 'yes') {
                    // do Request
                    requestTweets();
                } else {
                    // 如果更改了 Twitter 用户名，则清空先前的列表
                    if (localStorage['status_last_login_username'] != twitter_username) {
                        ['friends', 'replies', 'direct'].forEach(function(c){
                            Tweets.clearList(c);
                        });
                        Tweets.clearDiffNumber();
                    }

                    // 登录失败的回调
                    var loginFaild = function() {
                        console.error("user "+ twitter_username +" login faild");
                        localStorage['status_is_logined'] = 'no';
                        localStorage['status_last_login_username'] = '';
                        localStorage['status_last_login_time'] = '';
                        chrome.tabs.create({url: 'options.html'});
                    };

                    // 登录成功的回调
                    var loginSuccess = function() {
                        console.log("user "+ twitter_username +" login successful");
                        localStorage['status_is_logined'] = 'yes';
                        localStorage['status_last_login_username'] = twitter_username;
                        localStorage['status_last_login_time'] = new Date;

                        // do Request
                        requestTweets();
                    };

                    // 执行登录操作
                    Twitter.login({
                        onSuccess: function(o) {
                            var result = JSON.parse(o.responseText);
                            if (Lang.isUndefined(result.error)) {
                                localStorage['status_twitter_info'] = JSON.stringify(result);
                                loginSuccess();
                            } else {
                                loginFaild();
                            }
                        }, 

                        onError: function(o) {
                            loginFaild();
                        }
                    });
                }

                //chrome.tabs.create({url: 'popup.html'});
                window.requestTweets = requestTweets;
             }();
        </script>
    </body>
</html>
