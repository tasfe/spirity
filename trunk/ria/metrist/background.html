<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    </head>
    <body>
        <script type="text/javascript" src="assets/yui-special/yahoo.js"></script>
        <script type="text/javascript" src="assets/yui-special/dom.js"></script>
        <script type="text/javascript" src="assets/yui-special/event.js"></script>
        <script type="text/javascript" src="assets/yui-special/animation.js"></script>
        <script type="text/javascript" src="assets/yui-special/connection_core.js"></script>
        <script type="text/javascript" src="assets/scripts/common.js"></script>
        <script type="text/javascript" src="assets/scripts/twitter.js"></script>
        <script type="text/javascript">
            (function() {
                var Y = YAHOO, Lang = Y.lang;
                // window.console = logger;
                console.info('Background is running');

                var twitter_username = 'tbtest62', twitter_password = 'hello123';

                Twitter.setConfig({
                    //api: 'http://twitter.com',
                    api: 'http://lab.gracecode.com/twip-nobody-knows',
                    //username: 'tbtest62',
                    username: twitter_username,
                    password: twitter_password,
                    count: 5,
                    timeout: 5000
                });

                /*
                console.info(localStorage['status_is_logined']);
                console.info(localStorage['status_last_login_username']);
                console.info(localStorage['status_last_login_time']);
                console.info(localStorage['status_last_request_tweets']);
                */

                var timer;
                var requestTweets = function () {
                    console.log('Request tweets beginning.');
                    localStorage['status_last_request_tweets'] = new Date;

                    Twitter.getFriendsTimeline({
                        onSuccess: function(o) {
                            //console.info('getFriendsTimeline: ' + o.responseText);
                            localStorage["friends"] = o.responseText;
                            //YAHOO.lang.augmentObject(config, user_config, true);
                            console.log('getFriendsTimeline successful');
                        }, 
                        onError: function() {
                            console.error('getFriendsTimeline faild');
                        }
                    });

                    Twitter.getReplies({
                        onSuccess: function(o) {
                            //console.info('getReplies: ' + o.responseText);
                            localStorage["replies"] = o.responseText;
                            console.log('getReplies successful');
                        }, 
                        onError: function() {
                            console.error('getReplies faild');
                        }
                    });

                    Twitter.getDirectMessages({
                        onSuccess: function(o) {
                            //console.info('getDirectMessages: ' + o.responseText);
                            localStorage["direct"] = o.responseText;
                            console.log('getDirectMessages successful');
                        }, 
                        onError: function() {
                            console.error('getDirectMessages faild');
                        }
                    });

                    if (timer) {
                        timer.cancel();
                    }
                    timer = Lang.later(30 * 1000, Twitter, requestTweets);
                }
                window.requestTweets = requestTweets;

                // Already Login
                if (localStorage['status_last_login_username'] == twitter_username && localStorage['status_is_logined'] == 'yes') {
                    // do Request
                    requestTweets();
                } else {
                    ['friends', 'replies', 'direct'].forEach(function(c){
                        localStorage[c] = '';
                    });

                    var loginFaild = function() {
                        console.error("user "+ twitter_username +" login faild");
                        localStorage['status_is_logined'] = 'no';
                        localStorage['status_last_login_username'] = '';
                        localStorage['status_last_login_time'] = '';
                    };

                    var loginSuccess = function() {
                        console.log("user "+ twitter_username +" login successful");
                        localStorage['status_is_logined'] = 'yes';
                        localStorage['status_last_login_username'] = twitter_username;
                        localStorage['status_last_login_time'] = new Date;

                        // do Request
                        requestTweets();
                    };

                    Twitter.login({
                        onSuccess: function(o) {
                            var result = JSON.parse(o.responseText);
                            if (Lang.isUndefined(result.error)) {
                                loginSuccess();
                            } else {
                                loginFaild();
                            }
                        }, 

                        onError: function(o) {
                            loginFaild();
                        }
                    });
                }

                /*
                var request = YAHOO.util.Connect.asyncRequest('GET',
                    'http://lab.gracecode.com/twip-nobody-knows/account/verify_credentials.json',
                    {
                        success: function(o) {
                            console.info('success');
                            console.info(o.responseText);
                            console.info('status: ' + o.status);

                            // {"request":"/account/verify_credentials.json","error":"Could not authenticate you."}
                        },
                        failure: function(o) {
                            console.info('error');
                            console.info(o);
                        },
                        timeout: 5000
                    }, '', 'tbtest62', 'hello13');

                console.info(request);
                */

                /*


                */

                /*
                Twitter.getReplies({
                    onSuccess: function(o) {
                        console.info('getReplies: ' + o.responseText);
                        localStorage["replies"] = o.responseText;
                        logger.info('getReplies Successful');
                    }, 
                    onError: function() {
                        console.info('error');
                    }
                });

                Twitter.getDirectMessages({
                    onSuccess: function(o) {
                        console.info('getDirectMessages: ' + o.responseText);
                        localStorage["direct"] = o.responseText;
                        logger.info('getDirectMessages Successful');
                    }, 
                    onError: function() {
                        console.info('error');
                    }
                });
                */
                
                /*
                Twitter.sendDirectMessage('feelinglucky', 'hello, world! 你好，世界！', {
                    onSuccess: function(o) {
                        console.info(o.responseText);
                    }, 
                    onError: function() {
                        console.info('error');
                    }
                });

                Twitter.update('@chrome_metrist hello, world! 你好，世界！', {
                    onSuccess: function(o) {
                        console.info(o.responseText);
                    }, 
                    onError: function() {
                        console.info('error');
                    }
                });
                */

                chrome.tabs.create({url: 'popup.html'});
                //window.open('popup.html');
             })();
        </script>
    </body>
</html>
