<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    </head>
    <body>
        <script type="text/javascript" src="assets/yui-special/yahoo.js"></script>
        <script type="text/javascript" src="assets/yui-special/dom.js"></script>
        <script type="text/javascript" src="assets/yui-special/event.js"></script>
        <script type="text/javascript" src="assets/yui-special/animation.js"></script>
        <script type="text/javascript" src="assets/yui-special/connection_core.js"></script>
        <script type="text/javascript" src="assets/scripts/common.js"></script>
        <script type="text/javascript" src="assets/scripts/twitter.js"></script>
        <script type="text/javascript">
            ~function() {
                var Y = YAHOO, Lang = Y.lang, timer;

                window.console = logger;

                /*
                localStorage['conf_twitter_username'];
                localStorage['conf_twitter_password'];
                */
                var twitter_username = 'chrome_metrist', twitter_password = 'hello123';
                //var twitter_username = 'tbtest62', twitter_password = 'hello123';

                Twitter.setConfig({
                    //api: 'http://twitter.com',
                    api: 'http://lab.gracecode.com/twip-nobody-knows',
                    //username: 'tbtest62',
                    username: twitter_username,
                    password: twitter_password,
                    timeout: 5000
                });

                    var requestDataAndShow = function() {
                        // 获取用户本身数据，并添加到“好友”列表
                        Twitter.getUserTimeline(twitter_username, {
                            onSuccess: function(o) {
                                //console.info('getUserTimeline:');
                                //console.info(JSON.parse(o.responseText));
                                Tweets.addToList('friends', JSON.parse(o.responseText));
                                console.log('getUserTimeline successful');
                                getFriendsTimeline();
                            },
                            onError: function() {
                                console.error('getFriendsTimeline error!');
                            }
                        });
                    }

                    // 获取好友数据
                    var getFriendsTimeline = function() {
                        Twitter.getFriendsTimeline({
                            onSuccess: function(o) {
                                //console.info('getFriendsTimeline:');
                                //console.info(JSON.parse(o.responseText));
                                Tweets.addToList('friends', JSON.parse(o.responseText));
                                console.log('getFriendsTimeline successful');
                                getReplies();
                            }, 
                            onError: function() {
                                console.error('getFriendsTimeline faild');
                            }
                        });
                    }

                    // 获取回复数据
                    var getReplies = function () {
                        Twitter.getReplies({
                            onSuccess: function(o) {
                                //Tweets.addToList('friends', JSON.parse(o.responseText));
                                Tweets.addToList('replies', JSON.parse(o.responseText));
                                console.log('getReplies successful');
                                getDirectMessages();
                            }, 
                            onError: function() {
                                console.error('getReplies faild');
                            }
                        });
                    }

                    // 获取私信数据
                    var getDirectMessages = function() {
                        Twitter.getDirectMessages({
                            onSuccess: function(o) {
                                Tweets.addToList('direct', JSON.parse(o.responseText));
                                console.log('getDirectMessages successful');
                                if (Tweets.getDiffNumber()) {
                                    chrome.browserAction.setBadgeText({text: Tweets.getDiffNumber() + ''});
                                }
                            }, 
                            onError: function() {
                                console.error('getDirectMessages faild');
                            }
                        });
                    }


                /**
                 * 向服务器请求 Tweets 信息
                 */
                var requestTweets = function () {
                    localStorage['status_last_request_tweets'] = new Date;
                    if (timer) {
                        timer.cancel();
                    }
                    requestDataAndShow();
                    timer = Lang.later(5 * 60 * 1000, Twitter, requestTweets);
                }

                // Already Login
                if (localStorage['status_last_login_username'] == twitter_username && localStorage['status_is_logined'] == 'yes') {
                    // do Request
                    requestTweets();
                } else {
                    // 如果更改了 Twitter 用户名，则清空先前的列表
                    if (localStorage['status_last_login_username'] != twitter_username) {
                        ['friends', 'replies', 'direct'].forEach(function(c){
                            Tweets.clearList(c);
                        });
                        Tweets.clearDiffNumber();
                    }

                    // 登录失败的回调
                    var loginFaild = function() {
                        console.error("user "+ twitter_username +" login faild");
                        localStorage['status_is_logined'] = 'no';
                        localStorage['status_last_login_username'] = '';
                        localStorage['status_last_login_time'] = '';
                    };

                    // 登录成功的回调
                    var loginSuccess = function() {
                        console.log("user "+ twitter_username +" login successful");
                        localStorage['status_is_logined'] = 'yes';
                        localStorage['status_last_login_username'] = twitter_username;
                        localStorage['status_last_login_time'] = new Date;

                        // do Request
                        requestTweets();
                    };

                    // 执行登录操作
                    Twitter.login({
                        onSuccess: function(o) {
                            var result = JSON.parse(o.responseText);
                            if (Lang.isUndefined(result.error)) {
                                localStorage['status_twitter_info'] = JSON.stringify(result);
                                loginSuccess();
                            } else {
                                loginFaild();
                            }
                        }, 

                        onError: function(o) {
                            loginFaild();
                        }
                    });
                }

                //chrome.tabs.create({url: 'popup.html'});
                window.requestTweets = requestTweets;
             }();
        </script>
    </body>
</html>
