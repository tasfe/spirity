<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link href="assets/css/reset-min.css" rel="stylesheet" type="text/css" /> 
        <link href="assets/css/popup.css" rel="stylesheet" type="text/css" /> 
    </head>
    <body>
        <div id="page">
            <div id="content" style="visibility:hidden;">
                <div>
                    <ul class="tweets" id="metrist:friends" ref="friends">
                        <li id="234" screen_name="feelinglucky" tweets_text="item.text">
                            <h4 class="nick"><a href="#">明城</a></h4>
                            <p class="time">12h</p>
                            <p class="avatar"><img src="assets/images/avatar.png" /></p>
                            <p class="message">RT <a href="#">@feelinglucky</a>: 腾讯 TM 测试版的“锁定”功能非常棒</p>
                            <p class="act"><a href="#" act="Retweet">Retweet</a><a href="#" act="Reply">Reply</a></p>
                        </li>
                        <li class="reply">
                            <h4 class="nick"><a href="#">明城</a></h4>
                            <p class="time">12h</p>
                            <p class="avatar"><img src="assets/images/avatar.png" /></p>
                            <p class="message">RT <a href="#">@feelinglucky</a>: 腾讯 TM 测试版的“锁定”功能非常棒</p>
                            <p class="act"><a href="#" act="Retweet">Retweet</a><a href="#" act="Reply">Reply</a></p>
                        </li>
                        <li class="direct">
                            <h4 class="nick"><a href="#">明城</a></h4>
                            <p class="time">12h</p>
                            <p class="avatar"><img src="assets/images/avatar.png" /></p>
                            <p class="message">RT <a href="#">@feelinglucky</a>: 腾讯 TM 测试版的“锁定”功能非常棒</p>
                            <p class="act"><a href="#" act="Retweet">Retweet</a><a href="#" act="Reply">Reply</a></p>
                        </li>
                        <li class="me">
                            <h4 class="nick"><a href="#">明城</a></h4>
                            <p class="time">12h</p>
                            <p class="avatar"><img src="assets/images/avatar.png" /></p>
                            <p class="message">RT <a href="#">@feelinglucky</a>: 腾讯 TM 测试版的“锁定”功能非常棒</p>
                            <p class="act"><a href="#" act="Retweet">Retweet</a><a href="#" act="Reply">Reply</a></p>
                        </li>
                    </ul>
                    <ul class="tweets" id="metrist:replies" ref="replies">
                        <li class="reply">
                            <h4 class="nick"><a href="#">明城</a></h4>
                            <p class="time">12h</p>
                            <p class="avatar"><img src="assets/images/avatar.png" /></p>
                            <p class="message">RT <a href="#">@feelinglucky</a>: 腾讯 TM 测试版的“锁定”功能非常棒</p>
                            <p class="act"><a href="#" act="Retweet">Retweet</a><a href="#" act="Reply">Reply</a></p>
                        </li>
                    </ul>

                    <ul class="tweets" id="metrist:directs" ref="directs">
                        <li class="direct">
                            <h4 class="nick"><a href="#">明城</a></h4>
                            <p class="time">12h</p>
                            <p class="avatar"><img src="assets/images/avatar.png" /></p>
                            <p class="message">RT <a href="#">@feelinglucky</a>: 腾讯 TM 测试版的“锁定”功能非常棒</p>
                            <p class="act"><a href="#" act="Retweet">Retweet</a><a href="#" act="Reply">Reply</a></p>
                        </li>
                    </ul>
                    <ul class="console" id="metrist:console">
                        <li class="error">this is error!</li>
                        <li class="warn">this is warn</li>
                        <li class="log">this is log</li>
                    </ul>
                </div>
            </div>
            <div id="form">
                <form action="#" method="post" id="metrist:form">
                    <div id="tweet">
                        <textarea id="form:input"></textarea>
                        <span id="form:status">140</span>
                        <button type="submit" id="metrist:submit">&#187;</button>
                    </div>
                </form>
            </div>
            <ul id="channel">
                <li class="selected">Friends</li>
                <li>Replies</li>
                <li>Directs</li>
                <li id="channelConsole">Console</li>
            </ul>
            <a id="refresh" title="Refresh"><img src="assets/images/reload.png" width="16" height="16" /></a>
        </div>
        <div id="loading" class=""></div>
        <div id="notice" class=""><span>Hello, Metrist!</span></div>
        <script type="text/javascript" src="assets/yui-special/yahoo.js"></script>
        <script type="text/javascript" src="assets/yui-special/dom.js"></script>
        <script type="text/javascript" src="assets/yui-special/event.js"></script>
        <script type="text/javascript" src="assets/yui-special/animation.js"></script>
        <script type="text/javascript" src="assets/yui-special/connection_core.js"></script>
        <script type="text/javascript" src="assets/scripts/common.js"></script>
        <script type="text/javascript" src="ui.js"></script>
        <!--
        <script type="text/javascript" src="assets/scripts/ui_popup.js"></script>
        -->
        <script type="text/javascript">
            (function() {
                var Util = YAHOO.util, Dom = Util.Dom, Event = Util.Event, Lang = YAHOO.lang;

                var Tweets = (function() {
                    var backgroundPage = chrome.extension.getBackgroundPage();
                    var Server = backgroundPage.Server;
                    return {
                        update: function() {
                            backgroundPage.Twitter.update(UI.InputArea.getValue(), {
                                onSuccess: function(o) {
                                    console.info(o);
                                    UI.InputArea.setValue = '';
                                    UI.Notice.show('Update tweets successful');
                                    console.info('Update tweets successful')
                                },
                                onError: function() {
                                    UI.Loading.hide();
                                    console.info('Update tweets error')
                                }
                            });
                        },

                        getData: function(name) {
                            return backgroundPage.Tweets.getList(name);
                        },

                        isRequesting: function() {
                            return Server.status().requesting;
                        },

                        clearUnreadNum: function() {
                            Lang.later(5000, window, function() {
                                setBadgeText(unreadNumber ? unreadNumber : '');
                                backgroundPage.Tweets.clearUnreadNum();
                            });
                        }
                    };
                })();


                var TweetsTextAreaEl = Dom.get('form:input'), TweetsUpdateBtnEl = Dom.get('metrist:submit'),
                    TweetsUpdateFormEl = Dom.get('metrist:form');

                Event.on(TweetsUpdateFormEl, 'submit', function(e) {
                    Event.stopEvent(e);
                    if (UI.InputArea.check) { Tweets.update(); }
                });

                Event.on(TweetsTextAreaEl, 'keyup', function(e){
                    var e = Event.getEvent(e);
                    if (e.ctrlKey && e.keyCode == 13) {
                        Event.stopEvent(e);
                        Tweets.update();
                    }
                });

                UI.Channel.setSwitchToCall(function() {
                    var current = UI.Channel.getCurrentIdx(), 
                        container = UI.Channel.containers[current];
                    var loaded = Dom.getAttribute(container, 'loaded'),
                        ref = Dom.getAttribute(container, 'ref');
                    if (loaded != 'loaded' && ref) {
                        Dom.setAttribute(container, 'loaded', 'loaded');
                        try {
                            UI.Rebuild.channel(ref, Tweets.getData(ref));
                        } catch (e) {
                            console.error('UI.Rebuild.channel: build ['+ ref +'] error');
                        }
                    }
                });

                var defaultIdx = 0;

                //Dom.setStyle('content', 'visibility', 'hidden');
                UI.Loading.show(function() {
                    var foo = Lang.later(50, window, function() {
                        if (!Tweets.isRequesting()) {
                            foo.cancel();
                            UI.Loading.hide(function() {
                                Dom.setStyle('content', 'visibility', '');
                                Tweets.clearUnreadNum(); // clear unread
                                UI.Channel.switchTo(defaultIdx, false); // Hallelujah!!!
                            }, false);
                        }
                    }, null, true);
                });
             })();
        </script>
    </body>
</html>
